R Notebook for Milkbot M305
================

- [Raw Data import](#raw-data-import)
- [Data manipulation](#data-manipulation)
- [Model](#model)
  - [Base model](#base-model)
  - [Full model](#full-model)
  - [Comparison of baseline and nested
    model](#comparison-of-baseline-and-nested-model)
  - [Least square means](#least-square-means)

# Raw Data import

``` r
source('../DataImport.R')
```

# Data manipulation

``` r
#We inspect the quantile ranges
scale_this <- function(x){
  (x - mean(x, na.rm=F)) / sd(x, na.rm=F)
}

quantile(AllDataRaw$DaysPregnant)
```

    ##   0%  25%  50%  75% 100% 
    ##  150  275  278  283  297

``` r
AllData <- AllDataRaw %>% dplyr::filter(
                            LactationNumber == 1,
                            #DaysPregnant <= 283, #We drop all above 75th percentile because no interest at this stage, missing inseminations?
                            M305 > 0 #No missing M305 calculations
                            ) %>% 
                          dplyr::mutate(
                            Date  = mdy_hms(Date), #reformat ordering date
                            Year = year(mdy_hms(CalvingDate)),
                            Month = month(mdy_hms(CalvingDate)),
                            Age = scale(as.numeric(difftime(mdy_hms(CalvingDate), mdy_hms(BirthDate), units = "days"))),
                            DaysPregnantQuantile = case_when(
                              DaysPregnant < 243 ~ "0-1th Pct",
                              DaysPregnant < 267 ~ "1-5th Pct",
                              DaysPregnant < 275 ~ "5-25th Pct",
                              DaysPregnant < 283 ~ "25-75th Pct",
                              TRUE ~ "75-100 Pct"
                              )
                            ) %>%
                          dplyr::arrange(
                            HerdId,
                            AnimalId,
                            Date
                          ) %>%
                          dplyr::group_by(
                                          AnimalId,
                                          HerdId,
                                          DaysPregnantQuantile,
                                          Year,
                                          Month,
                                          CalvingDate,
                                          BirthDate
                                          ) %>% 
                          summarise(
                            Value = as.numeric(last(M305)),
                            Age = as.numeric(last(Age))
                            ) %>% 
                          tidyr::drop_na() 
```

    ## `summarise()` has grouped output by 'AnimalId', 'HerdId', 'DaysPregnantQuantile', 'Year', 'Month', 'CalvingDate'. You can override using the `.groups`
    ## argument.

``` r
AllData %>% ungroup %>% count()    
```

    ## # A tibble: 1 × 1
    ##       n
    ##   <int>
    ## 1 13732

``` r
AllData %>% ungroup %>% count(DaysPregnantQuantile)    
```

    ## # A tibble: 5 × 2
    ##   DaysPregnantQuantile     n
    ##   <chr>                <int>
    ## 1 0-1th Pct              129
    ## 2 1-5th Pct              501
    ## 3 25-75th Pct           7214
    ## 4 5-25th Pct            2231
    ## 5 75-100 Pct            3657

# Model

## Base model

``` r
baseline <- lmer(
                  Value ~ 1 +  (1 | HerdId), 
                  data = AllData,
                  REML = FALSE
                  )
qqnorm(residuals(baseline, type = 'pearson'))
```

![](M305_files/figure-gfm/unnamed-chunk-6-1.png)<!-- -->

## Full model

``` r
GLM <- lmer(
                  Value ~ 
                    DaysPregnantQuantile + Year + Month + DaysPregnantQuantile + Age
                     +  (1 | HerdId),
                  data = AllData,
                  REML = FALSE
                  )
qqnorm(residuals(GLM))
```

![](M305_files/figure-gfm/unnamed-chunk-7-1.png)<!-- -->

``` r
summary(GLM)
```

    ## Linear mixed model fit by maximum likelihood . t-tests use Satterthwaite's method ['lmerModLmerTest']
    ## Formula: Value ~ DaysPregnantQuantile + Year + Month + DaysPregnantQuantile +      Age + (1 | HerdId)
    ##    Data: AllData
    ## 
    ##       AIC       BIC    logLik  deviance  df.resid 
    ##  242623.9  242699.1 -121301.9  242603.9     13722 
    ## 
    ## Scaled residuals: 
    ##     Min      1Q  Median      3Q     Max 
    ## -4.2832 -0.5928  0.0402  0.6429  5.7155 
    ## 
    ## Random effects:
    ##  Groups   Name        Variance Std.Dev.
    ##  HerdId   (Intercept) 1120682  1059    
    ##  Residual             2690410  1640    
    ## Number of obs: 13732, groups:  HerdId, 89
    ## 
    ## Fixed effects:
    ##                                   Estimate Std. Error         df t value Pr(>|t|)    
    ## (Intercept)                     -9.254e+04  2.600e+04  1.372e+04  -3.559 0.000373 ***
    ## DaysPregnantQuantile1-5th Pct    2.360e+02  1.651e+02  1.368e+04   1.430 0.152811    
    ## DaysPregnantQuantile25-75th Pct  6.875e+02  1.501e+02  1.370e+04   4.580 4.69e-06 ***
    ## DaysPregnantQuantile5-25th Pct   5.819e+02  1.527e+02  1.370e+04   3.812 0.000139 ***
    ## DaysPregnantQuantile75-100 Pct   6.890e+02  1.507e+02  1.369e+04   4.573 4.84e-06 ***
    ## Year                             4.966e+01  1.289e+01  1.372e+04   3.852 0.000118 ***
    ## Month                            6.529e-02  4.146e+00  1.368e+04   0.016 0.987438    
    ## Age                              1.171e+02  1.653e+01  1.370e+04   7.087 1.43e-12 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Correlation of Fixed Effects:
    ##             (Intr) DPQ1-P DPQ25P DPQ5-P DPQ75P Year   Month 
    ## DysPrgQ1-5P -0.005                                          
    ## DysPQ25-75P -0.007  0.886                                   
    ## DysPrQ5-25P -0.004  0.870  0.964                            
    ## DyPQ75-100P -0.006  0.879  0.973  0.956                     
    ## Year        -1.000  0.000  0.002 -0.001  0.001              
    ## Month       -0.217 -0.007  0.005  0.002  0.000  0.216       
    ## Age         -0.046 -0.019 -0.010  0.000 -0.024  0.046  0.010

## Comparison of baseline and nested model

``` r
anova(GLM,baseline, test="Chisq")
```

    ## Data: AllData
    ## Models:
    ## baseline: Value ~ 1 + (1 | HerdId)
    ## GLM: Value ~ DaysPregnantQuantile + Year + Month + DaysPregnantQuantile + Age + (1 | HerdId)
    ##          npar    AIC    BIC  logLik deviance  Chisq Df Pr(>Chisq)    
    ## baseline    3 242734 242756 -121364   242728                         
    ## GLM        10 242624 242699 -121302   242604 123.65  7  < 2.2e-16 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

## Least square means

``` r
emm_options(pbkrtest.limit = 10880)
LSMs<-emmeans::emmeans(GLM, pairwise~DaysPregnantQuantile, type = "response", adjust="sidak", glhargs=list())
```

    ## Note: D.f. calculations have been disabled because the number of observations exceeds 10880.
    ## To enable adjustments, add the argument 'pbkrtest.limit = 13732' (or larger)
    ## [or, globally, 'set emm_options(pbkrtest.limit = 13732)' or larger];
    ## but be warned that this may result in large computation time and memory use.

    ## Note: D.f. calculations have been disabled because the number of observations exceeds 3000.
    ## To enable adjustments, add the argument 'lmerTest.limit = 13732' (or larger)
    ## [or, globally, 'set emm_options(lmerTest.limit = 13732)' or larger];
    ## but be warned that this may result in large computation time and memory use.

``` r
multcomp::cld(LSMs$emmeans, alpha=0.05, Letters=letters, adjust="sidak")
```

    ##  DaysPregnantQuantile emmean  SE  df asymp.LCL asymp.UCL .group
    ##  0-1th Pct              7566 186 Inf      7087      8045  a    
    ##  1-5th Pct              7802 136 Inf      7453      8151  a    
    ##  5-25th Pct             8148 119 Inf      7841      8455   b   
    ##  25-75th Pct            8254 116 Inf      7956      8551   b   
    ##  75-100 Pct             8255 117 Inf      7954      8556   b   
    ## 
    ## Degrees-of-freedom method: asymptotic 
    ## Confidence level used: 0.95 
    ## Conf-level adjustment: sidak method for 5 estimates 
    ## P value adjustment: sidak method for 10 tests 
    ## significance level used: alpha = 0.05 
    ## NOTE: If two or more means share the same grouping symbol,
    ##       then we cannot show them to be different.
    ##       But we also did not show them to be the same.

``` r
lsmeans::lsmeans(GLM, pairwise~DaysPregnantQuantile, type = "response", adjust="sidak", glhargs=list())
```

    ## Note: D.f. calculations have been disabled because the number of observations exceeds 10880.
    ## To enable adjustments, add the argument 'pbkrtest.limit = 13732' (or larger)
    ## [or, globally, 'set emm_options(pbkrtest.limit = 13732)' or larger];
    ## but be warned that this may result in large computation time and memory use.

    ## Note: D.f. calculations have been disabled because the number of observations exceeds 3000.
    ## To enable adjustments, add the argument 'lmerTest.limit = 13732' (or larger)
    ## [or, globally, 'set emm_options(lmerTest.limit = 13732)' or larger];
    ## but be warned that this may result in large computation time and memory use.

    ## $lsmeans
    ##  DaysPregnantQuantile emmean  SE  df asymp.LCL asymp.UCL
    ##  0-1th Pct              7566 186 Inf      7201      7931
    ##  1-5th Pct              7802 136 Inf      7536      8068
    ##  25-75th Pct            8254 116 Inf      8026      8481
    ##  5-25th Pct             8148 119 Inf      7914      8382
    ##  75-100 Pct             8255 117 Inf      8025      8485
    ## 
    ## Degrees-of-freedom method: asymptotic 
    ## Confidence level used: 0.95 
    ## 
    ## $contrasts
    ##  contrast                     estimate    SE  df z.ratio p.value
    ##  (0-1th Pct) - (1-5th Pct)     -236.03 165.1 Inf  -1.430  0.8095
    ##  (0-1th Pct) - (25-75th Pct)   -687.49 150.1 Inf  -4.580  <.0001
    ##  (0-1th Pct) - (5-25th Pct)    -581.91 152.7 Inf  -3.812  0.0014
    ##  (0-1th Pct) - (75-100 Pct)    -689.00 150.7 Inf  -4.573  <.0001
    ##  (1-5th Pct) - (25-75th Pct)   -451.46  76.8 Inf  -5.880  <.0001
    ##  (1-5th Pct) - (5-25th Pct)    -345.88  82.0 Inf  -4.220  0.0002
    ##  (1-5th Pct) - (75-100 Pct)    -452.97  79.1 Inf  -5.730  <.0001
    ##  (25-75th Pct) - (5-25th Pct)   105.58  40.6 Inf   2.598  0.0898
    ##  (25-75th Pct) - (75-100 Pct)    -1.52  34.7 Inf  -0.044  1.0000
    ##  (5-25th Pct) - (75-100 Pct)   -107.09  45.3 Inf  -2.366  0.1660
    ## 
    ## Degrees-of-freedom method: asymptotic 
    ## P value adjustment: sidak method for 10 tests
